# CMakeLists.txt for SYCL softmax kernel tests
cmake_minimum_required(VERSION 3.18)
project(softmax_sycl_test)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Find SYCL implementation
find_package(PkgConfig REQUIRED)
find_package(OpenCL REQUIRED)

# Try to find Intel oneAPI DPC++ compiler first
if(CMAKE_CXX_COMPILER MATCHES "icpx" OR CMAKE_CXX_COMPILER MATCHES "dpcpp")
  set(SYCL_COMPILER_FOUND TRUE)
  set(SYCL_FLAGS -fsycl)
else()
  # Check for other SYCL implementations
  if(DEFINED ENV{DPCPP_ROOT} OR DEFINED ENV{ONEAPI_ROOT})
    set(SYCL_ROOT $ENV{ONEAPI_ROOT})
    if(NOT SYCL_ROOT)
      set(SYCL_ROOT $ENV{DPCPP_ROOT})
    endif()
    set(SYCL_COMPILER ${SYYCL_ROOT}/compiler/linux/bin/icpx)
    if(EXISTS ${SYCL_COMPILER})
      set(SYCL_COMPILER_FOUND TRUE)
      set(SYCL_FLAGS -fsycl)
      set(CMAKE_CXX_COMPILER ${SYCL_COMPILER})
    endif()
  endif()

  if(NOT SYCL_COMPILER_FOUND)
    message(FATAL_ERROR "SYCL compiler not found. Please install Intel oneAPI DPC++.")
  endif()
endif()

# Add SYCL flags
add_compile_options(${SYCL_FLAGS})

# Add Google Test
set(GTEST_ROOT "/usr/src/googletest" CACHE STRING "Path to Google Test source")
if(EXISTS ${GTEST_ROOT})
  add_subdirectory(${GTEST_ROOT} googletest)
else()
  find_package(GTest REQUIRED)
endif()

# Create the test executable
add_executable(test_softmax_sycl
  ../../tests/test_softmax_sycl.cpp
)

# Link libraries
target_link_libraries(test_softmax_sycl
  PRIVATE
  GTest::gtest
  GTest::gtest_main
  OpenCL::OpenCL
)

# Set include directories
target_include_directories(test_softmax_sycl PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}/src
  ${CMAKE_CURRENT_SOURCE_DIR}/../neural/tables
)

# Add test
enable_testing()
add_test(NAME SoftmaxSYCLTests COMMAND test_softmax_sycl)

# Print configuration summary
message(STATUS "SYCL Compiler: ${CMAKE_CXX_COMPILER}")
message(STATUS "SYCL Flags: ${SYCL_FLAGS}")
message(STATUS "GTest found: ${GTEST_FOUND}")